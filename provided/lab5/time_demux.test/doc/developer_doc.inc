%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% this file was generated by docGen.py
% this file is intended to be edited
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tikzstyle{vecArrow} = [thick, decoration={markings,mark=at position
   1 with {\arrow[semithick]{open triangle 60}}},
   double distance=1.4pt, shorten >= 5.5pt,
   preaction = {decorate},
   postaction = {draw,line width=1.4pt, white,shorten >= 4.5pt}]
\tikzstyle{innerWhite} = [semithick, white,line width=1.4pt, shorten >= 4.5pt]
\newenvironment{absolutelynopagebreak}
  {\par\nobreak\vfil\penalty0\vfilneg
   \vtop\bgroup}
  {\par\xdef\tpd{\the\prevdepth}\egroup
   \prevdepth=\tpd}

\section*{Summary - \Comp}
% Make table whose width is equal to which will be used for text
% wrapping, split into 2 equal columns
\begin{longtable}{|p{\dimexpr0.5\textwidth-2\tabcolsep\relax}
                  |p{\dimexpr0.5\textwidth-2\tabcolsep\relax}|}
  \hline
  \rowcolor{blue}
  & \\
  \hline
  Name              & \comp \\
  \hline
  Latest Version    &  \docVersion  \space (4/2019) \\
  \hline
  Worker Type       &  Application\\
  \hline
  Component Library &  ocpi.training.components \\
  \hline
  Workers           &  \comp.rcc \\
  \hline
  Tested Platforms  &  linux-zynq-arm, c7-x86\_64 \\
  \hline
\end{longtable}

\section*{Functionality}
\begin{flushleft}
The Time Demux component acts as a demultiplexer/router by parsing an \verb+iqstream_with_sync+ protocol and routing timestamps and data to separate output ports.\\
\medskip
The incoming \verb+iqstream_with_sync+ supports three opcodes: \verb+iq+, \verb+Sync+, and \verb+Time+. The output ports use the \verb+iqstream+ and \verb+iqstream_with_sync+ protocols, the former using a single opcode. Data within the \verb+iqstream_with_sync+'s \verb+Time+ opcode (a single 64-bit value) is passed directly through, while data within the \verb+iq+ opcode is converted to \verb+iqstream+'s \verb+iq+ opcode's data (which, conveniently, is the same structure). The \verb+iqstream_with_sync+'s \verb+Sync+ opcode is currently ignored.\\
\end{flushleft}

%\section*{Worker Implementation Details}
%\begin{flushleft}
%\end{flushleft}

%\section*{Theory}
%\begin{flushleft}
%\end{flushleft}

\section*{Block Diagrams}
\subsection*{Top level}
\begin{center}
	\begin{tikzpicture}
	\tikzstyle{sharp} = [-latex]
	\node (mytd) [draw,rectangle,minimum width=6cm,minimum height=2.5cm] {\huge Time Demux};
	\draw[sharp] (-7,0) -- node[midway, below]{\textit{(iqstream\_with\_sync)}} node[midway, above]{Mux\_In} (mytd);
	\draw[sharp] (3,0.75) -- node[midway, below]{\textit{(iqstream\_with\_sync)}} node[midway, above]{Time\_Out} (7,0.75);
	\draw[sharp] (3,-0.75) -- node[midway, below]{\textit{(iqstream)}} node[midway, above]{Data\_Out} (7,-0.75);
	\end{tikzpicture}
    \captionof{figure}{Top-level Block Diagram}
    \label{fig:block_diagram}
\end{center}\pagebreak

%\subsection*{State Machine}
%\begin{flushleft}
%\end{flushleft}

\section*{Source Dependencies}
\subsection*{\comp.rcc}
        \begin{itemize}
		\item training/components/time\_demux.rcc/time\_demux.cc
	\end{itemize}
%\subsection*{\comp.hdl}

\begin{landscape}
  \input{component_spec_properties.inc} % it is recommended to NOT remove this line

  \input{worker_properties.inc} % it is recommended to NOT remove this line

  \input{component_ports.inc} % it is recommended to NOT remove this line

  \input{worker_interfaces.inc} % it is recommended to NOT remove this line
\end{landscape}

%\section*{Control Timing and Signals}
%\subsection*{\comp.hdl}
%\begin{flushleft}
%\end{flushleft}

%\section*{Performance and Resource Utilization}
%\subsubsection*{\comp.rcc}
%\subsubsection*{\comp.hdl}

\section*{Test and Verification}
\begin{flushleft}
This component uses the standard OpenCPI test process. It is one of the few that use multiple ports. \textbf{}
\begin{center}
\framebox{\parbox{0.8\linewidth}{\centering The only currently known issue is that the specfile must define the ``Data\_Out'' port \textit{first} to have the test application use it to signal ``done.''}}
\end{center}

% AV-2921
\iffalse
\subsubsection*{Usage (local/x86)}
After building the worker, the user only needs to type \verb+make tests+ in the \textit{time\_demux.test} directory. Options can be added to the command line as noted above, e.g. \verb+make tests INFILE=mybigfile+.

\subsubsection*{Usage (remote/ARM)}
To test the worker on a remote system, the user must ensure the remote is mounting the local filesystem properly. That setup is outside the scope of this document.\medskip

By changing ``\verb+make tests+'' to ``\verb+make show+'' in the \textit{time\_demux.test} directory, the user will be instructed concerning how to test, e.g.:
\begin{verbatim}
Locally: rm -f odata/output_{time,data}.bin
On device: ocpirun -d -v -t -5 app_time_demux
Locally: make verify
\end{verbatim}
\medskip
\fi
\subsection*{Advanced / Detailed Theory of Operation}
\textbf{This section is not essential to understand to perform the training lab.}\\

Testing of the Time Demux component consists of a C++ program (\textit{test\_data\_generator.cxx}) used to generate input data and expected ``golden'' outputs (Figure \ref{fig:generator}).\medskip

Fake timestamps and sample data are interleaved into an input file using the ``message mode'' format required to have \textit{ocpi.file\_read} playback opcodes with data. The C++ generator takes input arguments of: input file name, starting timestamp, number of samples to push each ``second,'' filename for the interleaved file, filename for the golden timestamps, and filename for the golden output file. These parameters are all handled by the OpenCPI test XML, with the test application shown in Figure \ref{fig:test_application}.\medskip
\iffalse
There is one OAS or Application XML (\textit{app\_time\_demux.xml}) that connects standard CDK-provided file reader and file writers to the UUT
\fi

Output data is compared to the golden file(s) by the Makefile (Figure \ref{fig:test_setup}).

\begin{center}
\begin{absolutelynopagebreak}
\begin{tikzpicture}[
  thick,
  minimum width={width("File Writer (data)")+10pt},
  minimum height={20pt},
  ]
  \node[draw,rectangle] (if) {Input File};
  \node[draw,rectangle,right = of if] (cxx) {test\_data\_generator};
  \node[draw,rectangle,right = of cxx] (inf) {idata/input\_file.bin};
  \node[draw,rectangle,fill=white,below = of inf] (gt) {odata/output\_time\_golden.bin};
  \node[draw,rectangle,fill=white,below = of gt] (gd) {odata/output\_data\_golden.bin};
  \draw[vecArrow] (if) to (cxx);
  \draw[vecArrow] (cxx) to (inf);
  \draw[vecArrow] (cxx) |- (gt);
  \draw[vecArrow] (cxx) |- (gd);
  % Fix broken corner:
  \draw[innerWhite] (cxx) |- (gt);
  \draw[innerWhite] (cxx) |- (gd);
\end{tikzpicture}
\captionof{figure}{C++ Generator Usage}
\label{fig:generator}
\end{absolutelynopagebreak}
\bigskip

\begin{absolutelynopagebreak}
\begin{tikzpicture}[
  thick,
  minimum width={width("File Writer (data)")+10pt},
  minimum height={20pt},
  ]
  \node[draw,rectangle] (fr) {File Reader};
  \node[draw,rectangle,right = of fr] (td) {Time Demux (UUT)};
  \node[draw,rectangle,fill=white,right = of td] (tfw) {File Writer (time)};
  \node[draw,rectangle,fill=white,below = of tfw] (dfw) {File Writer (data)};
  \draw[vecArrow] (fr) to (td);
  \draw[vecArrow] (td) to (tfw);
  \draw[vecArrow] (td) |- (dfw);
\end{tikzpicture}
\captionof{figure}{Test Application Layout (\textit{app\_time\_demux})}
\label{fig:test_application}
\end{absolutelynopagebreak}
\bigskip

\begin{absolutelynopagebreak}
\begin{tikzpicture}[
  thick,
  minimum width={width("File Writer (data)")+10pt},
  minimum height={20pt},
  ]
  \node[draw,rectangle] (gt) {Golden Time File};
  \node[draw,rectangle,below = of gt] (uutt) {Output Time File};
  \node[draw,rectangle,below = of uutt] (gd) {Golden Data File};
  \node[draw,rectangle,below = of gd] (uutd) {Output Data File};
  \node[draw,rectangle,right = of gt] (comparet) {Comparator};
  \node[draw,rectangle,right = of gd] (compared) {Comparator};
  \draw[vecArrow] (gt) to (comparet);
  \draw[vecArrow] (uutt) -| (comparet);
  \draw[vecArrow] (gd) to (compared);
  \draw[vecArrow] (uutd) -| (compared);
  % Note to anybody copy/pasting: you need to draw "innerWhite"s
  % over any intersections without nodes.
\end{tikzpicture}
\captionof{figure}{Testing}
\label{fig:test_setup}
\end{absolutelynopagebreak}
\end{center}
\bigskip

The default XML provides reasonable values for each of the data generator's required parameters:\\
	\begin{tabularx}{\textwidth}{|c|M{7cm}|M{7.3cm}|}
		\hline
		\rowcolor{blue}
		Test Property & Default & Notes \\
		\hline
		IFILE & (Running kernel image) \textit{e.g.} \verb+/boot/vmlinuz-3.10.0-327.4.4.el7.x86_64+ & The input file is truncated to a 32-bit boundary to simulate two 16-bit data samples. This may cause verification issues if using random files.\\
		&  & \\
		\hline
		START & 0 & Decimal only \\
		\hline
		SAMPLES & 256 & Should not exceed 2048 \\
		\hline
	\end{tabularx}\\

\medskip
For test purposes, the ``timestamp'' is a one-up counter starting at START placed in the upper 32-bits and then incremented and placed into the lower 32-bits:

% [language=X]
\begin{lstlisting}
$ od -t x8 odata/output_time_golden.bin | head
0000000 0000000000000001 0000000100000002
0000020 0000000200000003 0000000300000004
0000040 0000000400000005 0000000500000006
0000060 0000000600000007 0000000700000008
0000100 0000000800000009 000000090000000a
0000120 0000000a0000000b 0000000b0000000c
0000140 0000000c0000000d 0000000d0000000e
0000160 0000000e0000000f 0000000f00000010
0000200 0000001000000011 0000001100000012
0000220 0000001200000013 0000001300000014
\end{lstlisting}
\end{flushleft}
